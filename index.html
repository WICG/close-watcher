<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Close Watcher API</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version fb1e763a4, updated Tue Mar 1 13:13:50 2022 -0800" name="generator">
  <link href="https://wicg.github.io/close-watcher/" rel="canonical">
<style>
.selected-text-file-an-issue {
  position: fixed;
  bottom: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.8);
  font-size: smaller;
  padding: 4px 10px;
  z-index: 4;
}

dfn var {
  font-style: italic;
}

table {
  margin: 1em 0;
}

/* WHATWG-style <hr>s, instead of WICG-style. Specific selector is necessary to override WICG styles. */
:not(.head) > :not(.head) + hr {
  display: block;
  background: none;
  border: none;
  padding: 0;
  margin: 3em 0;
  height: auto;
}
:not(.head) > :not(.head) + hr::before {
  content: none;
}

/* domintro from https://resources.whatwg.org/standard.css */
.domintro {
  position: relative;
  color: green;
  background: #DDFFDD;
  margin: 2.5em 0 2em 0;
  padding: 1.5em 1em 0.5em 2em;
}

.domintro dt, .domintro dt * {
  color: black;
  font-size: inherit;
}
.domintro dd {
  margin: 0.5em 0 1em 2em; padding: 0;
}
.domintro dd p {
  margin: 0.5em 0;
}
.domintro::before {
  content: 'For web developers (non-normative)';
  background: green;
  color: white;
  padding: 0.15em 0.25em;
  font-style: normal;
  position: absolute;
  top: -0.8em;
  left: -0.8em;
}
</style>
<style>/* style-autolinks */

.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}</style>
<style>/* style-colors */

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}</style>
<style>/* style-counters */

body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}</style>
<style>/* style-dfn-panel */

:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    height: auto;
    width: -webkit-fit-content;
    width: fit-content;
    max-width: 300px;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0; }
.dfn-panel li { list-style: inside; }
.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled { cursor: pointer; }
</style>
<style>/* style-issues */

a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* style-md-lists */

/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}</style>
<style>/* style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* style-syntax-highlighting */

            pre.idl.highlight {
                background: var(--borderedblock-bg, var(--def-bg));
            }
            
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */
</style>
<style>/* style-var-click-highlighting */

    var { cursor: pointer; }
    var.selected0 { background-color: #F4D200; box-shadow: 0 0 0 2px #F4D200; }
    var.selected1 { background-color: #FF87A2; box-shadow: 0 0 0 2px #FF87A2; }
    var.selected2 { background-color: #96E885; box-shadow: 0 0 0 2px #96E885; }
    var.selected3 { background-color: #3EEED2; box-shadow: 0 0 0 2px #3EEED2; }
    var.selected4 { background-color: #EACFB6; box-shadow: 0 0 0 2px #EACFB6; }
    var.selected5 { background-color: #82DDFF; box-shadow: 0 0 0 2px #82DDFF; }
    var.selected6 { background-color: #FFBCF2; box-shadow: 0 0 0 2px #FFBCF2; }
    </style>
<style>/* style-darkmode */

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}

@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}
@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Close Watcher API</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="2022-03-07">7 March 2022</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://domenic.me/">Domenic Denicola</a> (<a class="p-org org" href="https://www.google.com/">Google</a>) <a class="u-email email" href="mailto:d@domenic.me">d@domenic.me</a>
     <dt>Participate:
     <dd><a href="https://github.com/WICG/close-watcher">GitHub WICG/close-watcher</a> (<a href="https://github.com/WICG/close-watcher/issues/new">new issue</a>, <a href="https://github.com/WICG/close-watcher/issues?state=open">open issues</a>)
     <dt>Commits:
     <dd><a href="https://github.com/WICG/close-watcher/commits/master/spec.bs">GitHub spec.bs commits</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2022 the Contributors to the Close Watcher API Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>The close watcher API provides a platform-agnostic way of handling close signals.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#close-signals"><span class="secno">1</span> <span class="content">Close signals</span></a>
     <ol class="toc">
      <li><a href="#close-watchers"><span class="secno">1.1</span> <span class="content">Close watcher infrastructure</span></a>
      <li><a href="#close-watcher-api"><span class="secno">1.2</span> <span class="content">Close watcher API</span></a>
     </ol>
    <li>
     <a href="#patches"><span class="secno">2</span> <span class="content">Updates to other specifications</span></a>
     <ol class="toc">
      <li><a href="#patch-fullscreen"><span class="secno">2.1</span> <span class="content">Fullscreen</span></a>
      <li><a href="#patch-dialog"><span class="secno">2.2</span> <span class="content">The <code><span>dialog</span></code> element</span></a>
     </ol>
    <li>
     <a href="#security-and-privacy"><span class="secno">3</span> <span class="content">Security and privacy considerations</span></a>
     <ol class="toc">
      <li><a href="#security"><span class="secno">3.1</span> <span class="content">Security considerations</span></a>
      <li><a href="#privacy"><span class="secno">3.2</span> <span class="content">Privacy considerations</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
   </ol>
  </nav>
  <main>
<script async src="https://resources.whatwg.org/file-issue.js"></script>
   <h2 class="heading settled" data-level="1" id="close-signals"><span class="secno">1. </span><span class="content">Close signals</span><a class="self-link" href="#close-signals"></a></h2>
   <p>(This section could be introduced as a new subsection of <a data-link-type="biblio" href="#biblio-html">[HTML]</a>'s <a href="https://html.spec.whatwg.org/#editing">User interaction</a> section.)</p>
   <p>In an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a> (and likely device-specific) manner, a user can send a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="close-signal">close signal</dfn> to the user agent. This indicates that the user wishes to close something which is currently being shown on the screen, such as a popup, menu, dialog, picker, or display mode.</p>
   <div class="example" id="example-close-signals">
    <a class="self-link" href="#example-close-signals"></a> Some example close signals are: 
    <ul>
     <li data-md>
      <p>The <kbd>Esc</kbd> key on desktop platforms</p>
     <li data-md>
      <p>The back button on Android</p>
     <li data-md>
      <p>The two-finger scrub "z" gesture on iOS when using VoiceOver (or, more generally, any assistive technology dismiss gesture)</p>
     <li data-md>
      <p>The square button on a DualShock (PlayStation) controller</p>
    </ul>
   </div>
   <p>Whenever the user agent receives a potential close signal targeted at a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> <var>document</var>, it must perform the following <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="close-signal-steps">close signal steps</dfn>:</p>
   <ol>
    <li data-md>
     <p>If <var>document</var>’s <a data-link-type="dfn" href="https://fullscreen.spec.whatwg.org/#fullscreen-element" id="ref-for-fullscreen-element">fullscreen element</a> is non-null, then <a data-link-type="dfn" href="https://fullscreen.spec.whatwg.org/#fully-exit-fullscreen" id="ref-for-fully-exit-fullscreen">fully exit fullscreen</a> and return.</p>
     <p class="note" role="note">This does <em>not</em> fire any relevant event, such as <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown">keydown</a></code>; it only fires <code class="idl"><a data-link-type="idl" href="https://fullscreen.spec.whatwg.org/#eventdef-document-fullscreenchange" id="ref-for-eventdef-document-fullscreenchange">fullscreenchange</a></code>. </p>
    <li data-md>
     <p>Fire any relevant event, per <cite>UI Events</cite> or other relevant specifications. <a data-link-type="biblio" href="#biblio-ui-events">[UI-EVENTS]</a></p>
     <p class="note" role="note">As an example of a relevant event that is outside of the model given in <cite>UI Events</cite>, current thinking is that assistive technology would <a href="https://github.com/WICG/aom/blob/gh-pages/explainer.md#user-action-events-from-assistive-technology">synthesize</a> an <kbd>Esc</kbd> <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown①">keydown</a></code> and <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keyup" id="ref-for-event-type-keyup">keyup</a></code> event sequence when the user sends a <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal">close signal</a> by using a dimiss gesture.</p>
      If multiple such events are fired, the user agent must pick one for the purposes of the following steps. 
     <p class="note" role="note">For example, it is typical on desktop platforms for pressing <em>down</em> on the <kbd>Esc</kbd> key to be a <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal①">close signal</a>. So, if assistive technology is synthesizing both <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown②">keydown</a></code> and <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keyup" id="ref-for-event-type-keyup①">keyup</a></code> events, then it would likely pick the <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown③">keydown</a></code> event for the next steps, to better match behavior of desktop platforms without assistive technology in play.</p>
    <li data-md>
     <p>If such an event was fired, and its <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#canceled-flag" id="ref-for-canceled-flag">canceled flag</a> is set, then return.</p>
    <li data-md>
     <p>If such an event was fired, then perform the following steps within the same task as that event was fired in, immediately after firing the event. Otherwise, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source" id="ref-for-user-interaction-task-source">user interaction task source</a> given <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global">relevant global object</a> to perform the following steps.</p>
    <li data-md>
     <p>If <var>document</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#fully-active" id="ref-for-fully-active">fully active</a>, then return.</p>
    <li data-md>
     <p>Let <var>closedSomething</var> be the result of <a data-link-type="dfn" href="#signal-close" id="ref-for-signal-close">signaling close</a> on <var>document</var>.</p>
    <li data-md>
     <p>If <var>closedSomething</var> was true, then return.</p>
    <li data-md>
     <p>Otherwise, there was nothing watching for a close signal. The user agent may instead interpret this interaction as some other action, instead of as a close signal.</p>
   </ol>
   <p class="example" id="example-desktop-esc-sequence"><a class="self-link" href="#example-desktop-esc-sequence"></a>On a desktop platform where <kbd>Esc</kbd> is the close signal, the user agent will first fire an appropriately-initialized <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown④">keydown</a></code> event. If the web developer intercepts this event and calls <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#dom-event-preventdefault" id="ref-for-dom-event-preventdefault">preventDefault()</a></code>, then nothing further happens. But if the event is fired without being canceled, then the user agent proceeds to <a data-link-type="dfn" href="#signal-close" id="ref-for-signal-close①">signal close</a>. </p>
   <p class="example" id="example-android-back-sequence"><a class="self-link" href="#example-android-back-sequence"></a>On Android where the back button is a potential close signal, no event is involved, so when the user agent determines that the back button represents a close signal, it <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task" id="ref-for-queue-a-task">queues a task</a> to <a data-link-type="dfn" href="#signal-close" id="ref-for-signal-close②">signal close</a>. If there is a <a data-link-type="dfn" href="#close-watcher-is-still-valid" id="ref-for-close-watcher-is-still-valid">still-valid</a> <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher">close watcher</a>, then that will get triggered; otherwise, the user agent will interpret the back button press as a request to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/history.html#traverse-the-history-by-a-delta" id="ref-for-traverse-the-history-by-a-delta">traverse the history by a delta</a> of −1. </p>
   <h3 class="heading settled" data-level="1.1" id="close-watchers"><span class="secno">1.1. </span><span class="content">Close watcher infrastructure</span><a class="self-link" href="#close-watchers"></a></h3>
   <p>Each <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="close-watcher-stack">close watcher stack</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#stack" id="ref-for-stack">stack</a> of <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher①">close watchers</a>, initially empty.</p>
   <p>Each <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/window-object.html#window" id="ref-for-window">Window</a></code> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="timestamp-of-last-activation-used-for-close-watchers">timestamp of last activation used for close watchers</dfn>. This is either a <code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/hr-time-2/#dom-domhighrestimestamp" id="ref-for-dom-domhighrestimestamp">DOMHighResTimeStamp</a></code> value, positive infinity, or negative infinity (i.e. the same value space as the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp" id="ref-for-last-activation-timestamp">last activation timestamp</a>). It is initially positive infinity.</p>
   <p class="note" role="note">This value is used to ensure that a given user activation only enables a single <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher">CloseWatcher</a></code> <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-cancel" id="ref-for-eventdef-closewatcher-cancel">cancel</a></code> or <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/interactive-elements.html#the-dialog-element" id="ref-for-the-dialog-element">dialog</a></code> <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-cancel" id="ref-for-event-cancel">cancel</a></code> event to be fired, per user activation. This is different than requiring <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation">transient activation</a> to fire the event, because we want to allow the event to happen arbitrarily long after the user activation. </p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="close-watcher">close watcher</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> with the following <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item">items</a>:</p>
   <ul>
    <li data-md>
     <p>A <dfn class="dfn-paneled" data-dfn-for="close watcher" data-dfn-type="dfn" data-export id="close-watcher-close-action">close action</dfn>, a list of steps. These steps can never throw an exception.</p>
    <li data-md>
     <p>An <dfn class="dfn-paneled" data-dfn-for="close watcher" data-dfn-type="dfn" data-export id="close-watcher-is-still-valid">is still valid</dfn> list of steps. These steps can never throw an exception, and return either true or false.</p>
    <li data-md>
     <p>A <dfn class="dfn-paneled" data-dfn-for="close watcher" data-dfn-type="dfn" data-export id="close-watcher-blocks-further-developer-controlled-close-watchers">blocks further developer-controlled close watchers</dfn> boolean.</p>
   </ul>
   <p class="note" role="note">The <a data-link-type="dfn" href="#close-watcher-is-still-valid" id="ref-for-close-watcher-is-still-valid①">is still valid</a> steps are a spec convenience that allows us to <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#stack-push" id="ref-for-stack-push">push</a> <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher②">close watchers</a> onto the <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack">stack</a> without having to add hooks to appropriately clean them up every time they become invalidated. Doing so can be tricky as in addition to explicit teardown steps, there are often implicit ones, e.g. by removing a relevant element from the document. </p>
   <div class="algorithm" data-algorithm="signal close">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="signal-close">signal close</dfn> given a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> <var>document</var>: 
    <ol>
     <li data-md>
      <p>While <var>document</var>’s <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack①">close watcher stack</a> is not empty:</p>
      <ol>
       <li data-md>
        <p>Let <var>closeWatcher</var> be the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#stack-pop" id="ref-for-stack-pop">popping</a> from <var>document</var>’s <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack②">close watcher stack</a>.</p>
       <li data-md>
        <p>If <var>closeWatcher</var>’s <a data-link-type="dfn" href="#close-watcher-is-still-valid" id="ref-for-close-watcher-is-still-valid②">is still valid</a> steps return true, then:</p>
        <ol>
         <li data-md>
          <p>Perform <var>closeWatcher</var>’s <a data-link-type="dfn" href="#close-watcher-close-action" id="ref-for-close-watcher-close-action">close action</a>.</p>
         <li data-md>
          <p>Return true.</p>
        </ol>
      </ol>
     <li data-md>
      <p>Return false.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="check if we can create a developer-controlled close watcher">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="check-if-we-can-create-a-developer-controlled-close-watcher">check if we can create a developer-controlled close watcher</dfn> for a <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/window-object.html#window" id="ref-for-window①">Window</a></code> <var>window</var>: 
    <ol>
     <li data-md>
      <p>Let <var>document</var> be <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" id="ref-for-concept-document-window">associated Document</a>.</p>
     <li data-md>
      <p>If <var>document</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#fully-active" id="ref-for-fully-active①">fully active</a>, then return false.</p>
     <li data-md>
      <p>Let <var>needsUserActivation</var> be false.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>closeWatcher</var> in <var>document</var>’s <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack③">close watcher stack</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>closeWatcher</var>’s <a data-link-type="dfn" href="#close-watcher-is-still-valid" id="ref-for-close-watcher-is-still-valid③">is still valid</a> steps return true, and <var>closeWatcher</var>’s <a data-link-type="dfn" href="#close-watcher-blocks-further-developer-controlled-close-watchers" id="ref-for-close-watcher-blocks-further-developer-controlled-close-watchers">blocks further developer-controlled close watchers</a> is true, then set <var>needsUserActivation</var> to true and <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-break" id="ref-for-iteration-break">break</a>.</p>
      </ol>
     <li data-md>
      <p>Let <var>canCreate</var> be false.</p>
     <li data-md>
      <p>If <var>needsUserActivation</var> is false, then set <var>canCreate</var> to true.</p>
     <li data-md>
      <p>Otherwise, if <var>window</var> has <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation①">transient activation</a>, then:</p>
      <ol>
       <li data-md>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation" id="ref-for-consume-user-activation">Consume user activation</a> given <var>window</var>.</p>
       <li data-md>
        <p>Set <var>canCreate</var> to true.</p>
      </ol>
     <li data-md>
      <p>If <var>canCreate</var> is true, then set <var>window</var>’s <a data-link-type="dfn" href="#timestamp-of-last-activation-used-for-close-watchers" id="ref-for-timestamp-of-last-activation-used-for-close-watchers">timestamp of last activation used for close watchers</a> to <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp" id="ref-for-last-activation-timestamp①">last activation timestamp</a>.</p>
     <li data-md>
      <p>Return <var>canCreate</var>.</p>
    </ol>
   </div>
   <h3 class="heading settled" data-level="1.2" id="close-watcher-api"><span class="secno">1.2. </span><span class="content">Close watcher API</span><a class="self-link" href="#close-watcher-api"></a></h3>
<pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="closewatcher"><code><c- g>CloseWatcher</c-></code></dfn> : <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#eventtarget" id="ref-for-eventtarget"><c- n>EventTarget</c-></a> {
  <a class="idl-code" data-link-type="constructor" href="#dom-closewatcher-closewatcher" id="ref-for-dom-closewatcher-closewatcher"><c- g>constructor</c-></a>();

  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined"><c- b>undefined</c-></a> <a class="idl-code" data-link-type="method" href="#dom-closewatcher-destroy" id="ref-for-dom-closewatcher-destroy"><c- g>destroy</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined①"><c- b>undefined</c-></a> <a class="idl-code" data-link-type="method" href="#dom-closewatcher-close" id="ref-for-dom-closewatcher-close"><c- g>close</c-></a>();

  <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler" id="ref-for-eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-closewatcher-oncancel" id="ref-for-dom-closewatcher-oncancel"><c- g>oncancel</c-></a>;
  <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler" id="ref-for-eventhandler①"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-closewatcher-onclose" id="ref-for-dom-closewatcher-onclose"><c- g>onclose</c-></a>;
};
</pre>
   <dl class="domintro non-normative">
    <dt><code><var>watcher</var> = new <code class="idl"><a data-link-type="idl" href="#dom-closewatcher-closewatcher" id="ref-for-dom-closewatcher-closewatcher①">CloseWatcher</a></code>()</code>
    <dd>
     <p>Attempts to create a new <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher①">CloseWatcher</a></code> instance. </p>
     <p>If a <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher②">CloseWatcher</a></code> is already active, and the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/window-object.html#window" id="ref-for-window②">Window</a></code> does not have <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation②">transient user activation</a>, then this will instead throw a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException">DOMException</a></code>. </p>
    <dt><code><var>watcher</var>.<code class="idl"><a data-link-type="idl" href="#dom-closewatcher-destroy" id="ref-for-dom-closewatcher-destroy①">destroy</a></code>()</code>
    <dd>
     <p>Deactivates this <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher③">CloseWatcher</a></code> instance, so that it will no longer receive <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-close" id="ref-for-eventdef-closewatcher-close">close</a></code> events and so that new <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher④">CloseWatcher</a></code> instances can be constructed. </p>
     <p>This is intended to be called if the relevant UI element is closed in some other way than via a <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal②">close signal</a>, e.g. by pressing an explicit "Close" button. </p>
    <dt><code><var>watcher</var>.<code class="idl"><a data-link-type="idl" href="#dom-closewatcher-close" id="ref-for-dom-closewatcher-close①">close</a></code>()</code>
    <dd>
     <p>Acts as if a <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal③">close signal</a> was sent targeting this <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher⑤">CloseWatcher</a></code> instance, by firing a <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-close" id="ref-for-eventdef-closewatcher-close①">close</a></code> event and deactivating the close watcher as if <code class="idl"><a data-link-type="idl" href="#dom-closewatcher-destroy" id="ref-for-dom-closewatcher-destroy②">destroy()</a></code> was called. </p>
     <p>This is a helper utility that can be used to consolidate closing logic into the <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-close" id="ref-for-eventdef-closewatcher-close②">close</a></code> event handler, by having all non-<a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal④">close signal</a> closing affordances call <code class="idl"><a data-link-type="idl" href="#dom-closewatcher-close" id="ref-for-dom-closewatcher-close②">close()</a></code>. </p>
   </dl>
   <p>Each <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher⑥">CloseWatcher</a></code> has an <dfn class="dfn-paneled" data-dfn-for="CloseWatcher" data-dfn-type="dfn" data-noexport id="closewatcher-is-active">is active</dfn>, which is a boolean, and an <dfn class="dfn-paneled" data-dfn-for="CloseWatcher" data-dfn-type="dfn" data-noexport id="closewatcher-firing-cancel-event">firing cancel event</dfn>, which is a boolean.</p>
   <div class="algorithm" data-algorithm="CloseWatcher()" data-algorithm-for="CloseWatcher">
     The <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="constructor" data-export data-lt="CloseWatcher()|constructor()" id="dom-closewatcher-closewatcher"><code>new CloseWatcher()</code></dfn> constructor steps are: 
    <ol>
     <li data-md>
      <p>If <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this">this</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global①">relevant global object</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" id="ref-for-concept-document-window①">associated Document</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#fully-active" id="ref-for-fully-active②">fully active</a>, then throw an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror">InvalidStateError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException①">DOMException</a></code>.</p>
     <li data-md>
      <p>If the result of <a data-link-type="dfn" href="#check-if-we-can-create-a-developer-controlled-close-watcher" id="ref-for-check-if-we-can-create-a-developer-controlled-close-watcher">checking if we can create a developer-controlled close watcher</a> for <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this①">this</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global②">relevant global object</a> is false, then throw a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror①">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException②">DOMException</a></code>.</p>
     <li data-md>
      <p>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this②">this</a>'s <a data-link-type="dfn" href="#closewatcher-is-active" id="ref-for-closewatcher-is-active">is active</a> to true.</p>
     <li data-md>
      <p>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this③">this</a>'s <a data-link-type="dfn" href="#closewatcher-firing-cancel-event" id="ref-for-closewatcher-firing-cancel-event">firing cancel event</a> to false.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#stack-push" id="ref-for-stack-push①">Push</a> a new <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher③">close watcher</a> on <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this④">this</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global③">relevant global object</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" id="ref-for-concept-document-window②">associated document</a>'s <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack④">close watcher stack</a>, with its <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item①">items</a> set as follows:</p>
      <ul>
       <li data-md>
        <p><a data-link-type="dfn" href="#close-watcher-close-action" id="ref-for-close-watcher-close-action①">close action</a> being to <a data-link-type="dfn" href="#closewatcher-signal-close" id="ref-for-closewatcher-signal-close">signal close</a> on <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this⑤">this</a></p>
       <li data-md>
        <p><a data-link-type="dfn" href="#close-watcher-is-still-valid" id="ref-for-close-watcher-is-still-valid④">is still valid</a> steps being to return <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this⑥">this</a>'s <a data-link-type="dfn" href="#closewatcher-is-active" id="ref-for-closewatcher-is-active①">is active</a></p>
       <li data-md>
        <p><a data-link-type="dfn" href="#close-watcher-blocks-further-developer-controlled-close-watchers" id="ref-for-close-watcher-blocks-further-developer-controlled-close-watchers①">blocks further developer-controlled close watchers</a> being true</p>
      </ul>
    </ol>
   </div>
   <p class="algorithm" data-algorithm="destroy()" data-algorithm-for="CloseWatcher"> The <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="method" data-export id="dom-closewatcher-destroy"><code>destroy()</code></dfn> method steps are to set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this⑦">this</a>'s <a data-link-type="dfn" href="#closewatcher-is-active" id="ref-for-closewatcher-is-active②">is active</a> to false. </p>
   <p class="algorithm" data-algorithm="close()" data-algorithm-for="CloseWatcher"> The <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="method" data-export id="dom-closewatcher-close"><code>close()</code></dfn> method steps are to <a data-link-type="dfn" href="#closewatcher-signal-close" id="ref-for-closewatcher-signal-close①">signal close</a> on <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this⑧">this</a>. </p>
   <p>Objects implementing the <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher⑦">CloseWatcher</a></code> interface must support the <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="attribute" data-export id="dom-closewatcher-oncancel"><code>oncancel</code></dfn> and <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="attribute" data-export id="dom-closewatcher-onclose"><code>onclose</code></dfn> <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes" id="ref-for-event-handler-idl-attributes">event handler IDL attribute</a>, whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-event-type" id="ref-for-event-handler-event-type">event handler event types</a> are respectively <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="event" data-export id="eventdef-closewatcher-cancel"><code>cancel</code></dfn> and <dfn class="dfn-paneled idl-code" data-dfn-for="CloseWatcher" data-dfn-type="event" data-export id="eventdef-closewatcher-close"><code>close</code></dfn>.</p>
   <div class="algorithm" data-algorithm="signal close" data-algorithm-for="CloseWatcher">
     To <dfn class="dfn-paneled" data-dfn-for="CloseWatcher" data-dfn-type="dfn" data-noexport id="closewatcher-signal-close">signal close</dfn> on a <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher⑧">CloseWatcher</a></code> <var>closeWatcher</var>: 
    <ol>
     <li data-md>
      <p>If <var>closeWatcher</var>’s <a data-link-type="dfn" href="#closewatcher-is-active" id="ref-for-closewatcher-is-active③">is active</a> is false, then return.</p>
     <li data-md>
      <p>If <var>closeWatcher</var>’s <a data-link-type="dfn" href="#closewatcher-firing-cancel-event" id="ref-for-closewatcher-firing-cancel-event①">firing cancel event</a> is true, then return.</p>
     <li data-md>
      <p>Let <var>window</var> be <var>closeWatcher</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global④">relevant global object</a>.</p>
     <li data-md>
      <p>If <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" id="ref-for-concept-document-window③">associated Document</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#fully-active" id="ref-for-fully-active③">fully active</a>, and <var>window</var>’s <a data-link-type="dfn" href="#timestamp-of-last-activation-used-for-close-watchers" id="ref-for-timestamp-of-last-activation-used-for-close-watchers①">timestamp of last activation used for close watchers</a> does not equal <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp" id="ref-for-last-activation-timestamp②">last activation timestamp</a>, then:</p>
      <ol>
       <li data-md>
        <p>Set <var>window</var>’s <a data-link-type="dfn" href="#timestamp-of-last-activation-used-for-close-watchers" id="ref-for-timestamp-of-last-activation-used-for-close-watchers②">timestamp of last activation used for close watchers</a> to <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp" id="ref-for-last-activation-timestamp③">last activation timestamp</a>.</p>
       <li data-md>
        <p>Set <var>closeWatcher</var>’s <a data-link-type="dfn" href="#closewatcher-firing-cancel-event" id="ref-for-closewatcher-firing-cancel-event②">firing cancel event</a> to true.</p>
       <li data-md>
        <p>Let <var>shouldContinue</var> be the result of <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire">firing an event</a> named <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-cancel" id="ref-for-eventdef-closewatcher-cancel①">cancel</a></code> at <var>closeWatcher</var>, with the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#dom-event-cancelable" id="ref-for-dom-event-cancelable">cancelable</a></code> attribute initialized to true.</p>
       <li data-md>
        <p>Set <var>closeWatcher</var>’s <a data-link-type="dfn" href="#closewatcher-firing-cancel-event" id="ref-for-closewatcher-firing-cancel-event③">firing cancel event</a> to false.</p>
       <li data-md>
        <p>If <var>shouldContinue</var> is false, then return.</p>
      </ol>
     <li data-md>
      <p>If <var>closeWatcher</var>’s <a data-link-type="dfn" href="#closewatcher-is-active" id="ref-for-closewatcher-is-active④">is active</a> is true, and <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" id="ref-for-concept-document-window④">associated Document</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#fully-active" id="ref-for-fully-active④">fully active</a>, then <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire①">fire an event</a> named <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-close" id="ref-for-eventdef-closewatcher-close③">close</a></code> at <var>closeWatcher</var>.</p>
     <li data-md>
      <p>Set <var>closeWatcher</var>’s <a data-link-type="dfn" href="#closewatcher-is-active" id="ref-for-closewatcher-is-active⑤">is active</a> to false.</p>
    </ol>
   </div>
   <h2 class="heading settled" data-level="2" id="patches"><span class="secno">2. </span><span class="content">Updates to other specifications</span><a class="self-link" href="#patches"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="patch-fullscreen"><span class="secno">2.1. </span><span class="content">Fullscreen</span><a class="self-link" href="#patch-fullscreen"></a></h3>
   <p>Replace the sentence about "If the end user instructs..." in <a href="https://fullscreen.spec.whatwg.org/#ui"><cite>Fullscreen API</cite> § 4 UI</a> with the following:</p>
   <p>If the user initiates a <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal⑤">close signal</a>, this will trigger the <a data-link-type="dfn" href="https://fullscreen.spec.whatwg.org/#fully-exit-fullscreen" id="ref-for-fully-exit-fullscreen①">fully exit fullscreen</a> algorithm as part of the <a data-link-type="dfn" href="#close-signal-steps" id="ref-for-close-signal-steps">close signal steps</a>. This takes precedence over any <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher④">close watchers</a>.</p>
   <h3 class="heading settled" data-level="2.2" id="patch-dialog"><span class="secno">2.2. </span><span class="content">The <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/interactive-elements.html#the-dialog-element" id="ref-for-the-dialog-element①">dialog</a></code> element</span><a class="self-link" href="#patch-dialog"></a></h3>
   <p>Update <cite>HTML</cite>’s <a href="https://html.spec.whatwg.org/multipage/interactive-elements.html#the-dialog-element" id="termref-for-the-dialog-element">The <code>dialog</code> element</a> section as follows: <a data-link-type="biblio" href="#biblio-html">[HTML]</a></p>
   <div class="algorithm" data-algorithm="showModal patch">
     In the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/interactive-elements.html#dom-dialog-showmodal" id="ref-for-dom-dialog-showmodal">showModal()</a></code> steps, after adding <var>subject</var> to the <a data-link-type="dfn" href="https://fullscreen.spec.whatwg.org/#top-layer" id="ref-for-top-layer">top layer</a>, append the following step: 
    <ol>
     <li data-md>
      <p>If the result of <a data-link-type="dfn" href="#check-if-we-can-create-a-developer-controlled-close-watcher" id="ref-for-check-if-we-can-create-a-developer-controlled-close-watcher①">checking if we can create a developer-controlled close watcher</a> given <var>subject</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global⑤">relevant global object</a> is true, then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#stack-push" id="ref-for-stack-push②">push</a> a new <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher⑤">close watcher</a> on <var>subject</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-document" id="ref-for-concept-node-document">node document</a>'s <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack⑤">close watcher stack</a>, with its <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item②">items</a> set as follows:</p>
      <ul>
       <li data-md>
        <p><a data-link-type="dfn" href="#close-watcher-close-action" id="ref-for-close-watcher-close-action②">close action</a> being to <a data-link-type="dfn" href="#cancel-the-dialog" id="ref-for-cancel-the-dialog">cancel the dialog</a> <var>subject</var></p>
       <li data-md>
        <p><a data-link-type="dfn" href="#close-watcher-is-still-valid" id="ref-for-close-watcher-is-still-valid⑤">is still valid</a> steps being to return true if <var>subject</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-document" id="ref-for-concept-node-document①">node document</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#blocked-by-a-modal-dialog" id="ref-for-blocked-by-a-modal-dialog">blocked by the modal dialog</a> <var>subject</var>, and return false otherwise</p>
       <li data-md>
        <p><a data-link-type="dfn" href="#close-watcher-blocks-further-developer-controlled-close-watchers" id="ref-for-close-watcher-blocks-further-developer-controlled-close-watchers②">blocks further developer-controlled close watchers</a> being true</p>
      </ul>
      <p class="note" role="note">If we cannot create a developer-controlled close watcher, then this modal dialog will not respond to <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal⑥">close signals</a>. The <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/interactive-elements.html#dom-dialog-showmodal" id="ref-for-dom-dialog-showmodal①">showModal()</a></code> method proceeds without any exception or other indication of this, although the browser could <a data-link-type="dfn" href="https://console.spec.whatwg.org/#report-a-warning-to-the-console" id="ref-for-report-a-warning-to-the-console">report a warning to the console</a>. </p>
    </ol>
   </div>
   <p>Replace the "Canceling dialogs" section entirely with the following definition. (The previous prose about providing a user interface to cancel such dialogs, and the task-queuing, is now handled by the infrastructure in <a href="#close-signals">§ 1 Close signals</a>.)</p>
   <div class="algorithm" data-algorithm="cancel the dialog">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="cancel-the-dialog">cancel the dialog</dfn> <var>dialog</var>: 
    <ol>
     <li data-md>
      <p>Let <var>window</var> be <var>dialog</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global⑥">relevant global object</a>.</p>
     <li data-md>
      <p>If <var>window</var>’s <a data-link-type="dfn" href="#timestamp-of-last-activation-used-for-close-watchers" id="ref-for-timestamp-of-last-activation-used-for-close-watchers③">timestamp of last activation used for close watchers</a> does not equal <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp" id="ref-for-last-activation-timestamp④">last activation timestamp</a>, then:</p>
      <ol>
       <li data-md>
        <p>Let <var>shouldContinue</var> to the result of <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire②">firing an event</a> named <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-cancel" id="ref-for-event-cancel①">cancel</a></code> at <var>dialog</var>, with the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#dom-event-cancelable" id="ref-for-dom-event-cancelable①">cancelable</a></code> attribute initialized to true.</p>
       <li data-md>
        <p>Set <var>window</var>’s <a data-link-type="dfn" href="#timestamp-of-last-activation-used-for-close-watchers" id="ref-for-timestamp-of-last-activation-used-for-close-watchers④">timestamp of last activation used for close watchers</a> to <var>window</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp" id="ref-for-last-activation-timestamp⑤">last activation timestamp</a>.</p>
       <li data-md>
        <p>If <var>shouldContinue</var> is false, then return.</p>
      </ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interactive-elements.html#close-the-dialog" id="ref-for-close-the-dialog">Close the dialog</a> <var>dialog</var> with no return value.</p>
    </ol>
   </div>
   <h2 class="heading settled" data-level="3" id="security-and-privacy"><span class="secno">3. </span><span class="content">Security and privacy considerations</span><a class="self-link" href="#security-and-privacy"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="security"><span class="secno">3.1. </span><span class="content">Security considerations</span><a class="self-link" href="#security"></a></h3>
   <p>The main security consideration with this API is preventing abusive pages from hijacking the fallback behavior in the last part of the <a data-link-type="dfn" href="#close-signal-steps" id="ref-for-close-signal-steps①">close signal steps</a>. A concrete example is on Android, where the <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal⑦">close signal</a> is the software back button, and this fallback behavior is to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/history.html#traverse-the-history-by-a-delta" id="ref-for-traverse-the-history-by-a-delta①">traverse the history by a delta</a> of −1. If developers could always intercept Android back button presses via <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher⑨">CloseWatcher</a></code> instances and <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/interactive-elements.html#the-dialog-element" id="ref-for-the-dialog-element②">dialog</a></code> elements, then they could effectively break the back button by never letting it pass through to the fallback behavior.</p>
   <p>Much of the complexity of this specification is designed around preventing such abuse. Without it, the API could consist of a single event. But with this constraint, we need an API surface such as the <code class="idl"><a data-link-type="idl" href="#dom-closewatcher-closewatcher" id="ref-for-dom-closewatcher-closewatcher②">CloseWatcher()</a></code> constructor which can be gated by additional checks, as well as the <a data-link-type="dfn" href="#close-watcher-stack" id="ref-for-close-watcher-stack⑥">close watcher stack</a> to ensure that each <a data-link-type="dfn" href="#close-watcher" id="ref-for-close-watcher⑥">close watcher</a> can only consume a single <a data-link-type="dfn" href="#close-signal" id="ref-for-close-signal⑧">close signal</a>.</p>
   <p>Concretely, the mechanism of <a data-link-type="dfn" href="#check-if-we-can-create-a-developer-controlled-close-watcher" id="ref-for-check-if-we-can-create-a-developer-controlled-close-watcher②">checking if we can create a developer-controlled close watcher</a> ensures that web developers can only create <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher①⓪">CloseWatcher</a></code> instances, or call <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#dom-event-preventdefault" id="ref-for-dom-event-preventdefault①">preventDefault()</a></code> on <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-cancel" id="ref-for-eventdef-closewatcher-cancel②">cancel</a></code> events, by <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#activation-consuming-api" id="ref-for-activation-consuming-api">consuming user activation</a>. This gives similar protections to what browsers have in place today, where back button UI skips entries that were added without user activation.</p>
   <p>We do allow one "free" <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher①①">CloseWatcher</a></code> to be created, without consuming user activation, to handle cases like session inactivity timeout dialogs, or urgent notifications of server-triggered events. The end result is that this specification expands the number of Android back button presses that a maximally-abusive page could require to escape from <var>number of user activations</var> + 1 to <var>number of user activations</var> + 2. (See <a href="https://github.com/WICG/close-watcher#abuse-analysis">the explainer</a> for a full analysis.) We believe this tradeoff is worthwhile.</p>
   <h3 class="heading settled" data-level="3.2" id="privacy"><span class="secno">3.2. </span><span class="content">Privacy considerations</span><a class="self-link" href="#privacy"></a></h3>
   <p>We believe the privacy impact of this API is minimal. The only information it gives about the user to the web developer is that a close signal has occurred, which is a very infrequent and coarse piece of user input.</p>
   <p>In all cases we’re aware of today, such close signals are already detectable by web developers (e.g., by using <code class="idl"><a class="idl-code" data-link-type="event" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown⑤">keydown</a></code> listeners on desktop or <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-popstate" id="ref-for-event-popstate">popstate</a></code> listeners on Android). In theory, by correlating these existing events with the <code class="idl"><a data-link-type="idl" href="#closewatcher" id="ref-for-closewatcher①②">CloseWatcher</a></code>'s <code class="idl"><a data-link-type="idl" href="#eventdef-closewatcher-close" id="ref-for-eventdef-closewatcher-close④">close</a></code> event, a web developer could determine some information about the platform. (I.e., if they correlate with <code class="idl"><a class="idl-code" data-link-type="event" href="https://w3c.github.io/uievents/#event-type-keydown" id="ref-for-event-type-keydown⑥">keydown</a></code> events, the user is likely on desktop, or at least on a keyboard-attached mobile device.) This is similar to existing techniques which detect whether touch events or mouse events are fired, and user agents which want to emulate a different platform in order to mask the user’s choice might want to apply similar mitigation techniques for close watchers as they do for other platform-revealing events.</p>
  </main>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#close-watcher-blocks-further-developer-controlled-close-watchers">blocks further developer-controlled close watchers</a><span>, in § 1.1</span>
   <li><a href="#eventdef-closewatcher-cancel">cancel</a><span>, in § 1.2</span>
   <li><a href="#cancel-the-dialog">cancel the dialog</a><span>, in § 2.2</span>
   <li><a href="#check-if-we-can-create-a-developer-controlled-close-watcher">check if we can create a developer-controlled close watcher</a><span>, in § 1.1</span>
   <li><a href="#eventdef-closewatcher-close">close</a><span>, in § 1.2</span>
   <li><a href="#dom-closewatcher-close">close()</a><span>, in § 1.2</span>
   <li><a href="#close-watcher-close-action">close action</a><span>, in § 1.1</span>
   <li><a href="#close-signal">close signal</a><span>, in § 1</span>
   <li><a href="#close-signal-steps">close signal steps</a><span>, in § 1</span>
   <li><a href="#close-watcher">close watcher</a><span>, in § 1.1</span>
   <li><a href="#closewatcher">CloseWatcher</a><span>, in § 1.2</span>
   <li><a href="#dom-closewatcher-closewatcher">CloseWatcher()</a><span>, in § 1.2</span>
   <li><a href="#close-watcher-stack">close watcher stack</a><span>, in § 1.1</span>
   <li><a href="#dom-closewatcher-closewatcher">constructor()</a><span>, in § 1.2</span>
   <li><a href="#dom-closewatcher-destroy">destroy()</a><span>, in § 1.2</span>
   <li><a href="#closewatcher-firing-cancel-event">firing cancel event</a><span>, in § 1.2</span>
   <li><a href="#closewatcher-is-active">is active</a><span>, in § 1.2</span>
   <li><a href="#close-watcher-is-still-valid">is still valid</a><span>, in § 1.1</span>
   <li><a href="#dom-closewatcher-oncancel">oncancel</a><span>, in § 1.2</span>
   <li><a href="#dom-closewatcher-onclose">onclose</a><span>, in § 1.2</span>
   <li>
    signal close
    <ul>
     <li><a href="#signal-close">definition of</a><span>, in § 1.1</span>
     <li><a href="#closewatcher-signal-close">dfn for CloseWatcher</a><span>, in § 1.2</span>
    </ul>
   <li><a href="#timestamp-of-last-activation-used-for-close-watchers">timestamp of last activation used for close watchers</a><span>, in § 1.1</span>
  </ul>
  <aside class="dfn-panel" data-for="term-for-report-a-warning-to-the-console">
   <a href="https://console.spec.whatwg.org/#report-a-warning-to-the-console">https://console.spec.whatwg.org/#report-a-warning-to-the-console</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-report-a-warning-to-the-console">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-document">
   <a href="https://dom.spec.whatwg.org/#document">https://dom.spec.whatwg.org/#document</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-document">1. Close signals</a>
    <li><a href="#ref-for-document①">1.1. Close watcher infrastructure</a> <a href="#ref-for-document②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-eventtarget">
   <a href="https://dom.spec.whatwg.org/#eventtarget">https://dom.spec.whatwg.org/#eventtarget</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-eventtarget">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-event-cancelable">
   <a href="https://dom.spec.whatwg.org/#dom-event-cancelable">https://dom.spec.whatwg.org/#dom-event-cancelable</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-event-cancelable">1.2. Close watcher API</a>
    <li><a href="#ref-for-dom-event-cancelable①">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-canceled-flag">
   <a href="https://dom.spec.whatwg.org/#canceled-flag">https://dom.spec.whatwg.org/#canceled-flag</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-canceled-flag">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-event-fire">
   <a href="https://dom.spec.whatwg.org/#concept-event-fire">https://dom.spec.whatwg.org/#concept-event-fire</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-event-fire">1.2. Close watcher API</a> <a href="#ref-for-concept-event-fire①">(2)</a>
    <li><a href="#ref-for-concept-event-fire②">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-node-document">
   <a href="https://dom.spec.whatwg.org/#concept-node-document">https://dom.spec.whatwg.org/#concept-node-document</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-node-document">2.2. The dialog element</a> <a href="#ref-for-concept-node-document①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-event-preventdefault">
   <a href="https://dom.spec.whatwg.org/#dom-event-preventdefault">https://dom.spec.whatwg.org/#dom-event-preventdefault</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-event-preventdefault">1. Close signals</a>
    <li><a href="#ref-for-dom-event-preventdefault①">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-fullscreen-element">
   <a href="https://fullscreen.spec.whatwg.org/#fullscreen-element">https://fullscreen.spec.whatwg.org/#fullscreen-element</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-fullscreen-element">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-eventdef-document-fullscreenchange">
   <a href="https://fullscreen.spec.whatwg.org/#eventdef-document-fullscreenchange">https://fullscreen.spec.whatwg.org/#eventdef-document-fullscreenchange</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-eventdef-document-fullscreenchange">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-fully-exit-fullscreen">
   <a href="https://fullscreen.spec.whatwg.org/#fully-exit-fullscreen">https://fullscreen.spec.whatwg.org/#fully-exit-fullscreen</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-fully-exit-fullscreen">1. Close signals</a>
    <li><a href="#ref-for-fully-exit-fullscreen①">2.1. Fullscreen</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-top-layer">
   <a href="https://fullscreen.spec.whatwg.org/#top-layer">https://fullscreen.spec.whatwg.org/#top-layer</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-top-layer">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-domhighrestimestamp">
   <a href="https://www.w3.org/TR/hr-time-2/#dom-domhighrestimestamp">https://www.w3.org/TR/hr-time-2/#dom-domhighrestimestamp</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-domhighrestimestamp">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-eventhandler">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler">https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-eventhandler">1.2. Close watcher API</a> <a href="#ref-for-eventhandler①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-window">
   <a href="https://html.spec.whatwg.org/multipage/window-object.html#window">https://html.spec.whatwg.org/multipage/window-object.html#window</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-window">1.1. Close watcher infrastructure</a> <a href="#ref-for-window①">(2)</a>
    <li><a href="#ref-for-window②">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-document-window">
   <a href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window">https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-document-window">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-concept-document-window①">1.2. Close watcher API</a> <a href="#ref-for-concept-document-window②">(2)</a> <a href="#ref-for-concept-document-window③">(3)</a> <a href="#ref-for-concept-document-window④">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-blocked-by-a-modal-dialog">
   <a href="https://html.spec.whatwg.org/multipage/interaction.html#blocked-by-a-modal-dialog">https://html.spec.whatwg.org/multipage/interaction.html#blocked-by-a-modal-dialog</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-blocked-by-a-modal-dialog">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-event-cancel">
   <a href="https://html.spec.whatwg.org/multipage/indices.html#event-cancel">https://html.spec.whatwg.org/multipage/indices.html#event-cancel</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-event-cancel">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-event-cancel①">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-close-the-dialog">
   <a href="https://html.spec.whatwg.org/multipage/interactive-elements.html#close-the-dialog">https://html.spec.whatwg.org/multipage/interactive-elements.html#close-the-dialog</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-the-dialog">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-consume-user-activation">
   <a href="https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation">https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-consume-user-activation">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-the-dialog-element">
   <a href="https://html.spec.whatwg.org/multipage/interactive-elements.html#the-dialog-element">https://html.spec.whatwg.org/multipage/interactive-elements.html#the-dialog-element</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-the-dialog-element">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-the-dialog-element①">2.2. The dialog element</a> <a href="#termref-for-the-dialog-element">(2)</a>
    <li><a href="#ref-for-the-dialog-element②">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-event-handler-event-type">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-event-type">https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-event-type</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-event-handler-event-type">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-event-handler-idl-attributes">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes">https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-event-handler-idl-attributes">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-fully-active">
   <a href="https://html.spec.whatwg.org/multipage/browsers.html#fully-active">https://html.spec.whatwg.org/multipage/browsers.html#fully-active</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-fully-active">1. Close signals</a>
    <li><a href="#ref-for-fully-active①">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-fully-active②">1.2. Close watcher API</a> <a href="#ref-for-fully-active③">(2)</a> <a href="#ref-for-fully-active④">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-last-activation-timestamp">
   <a href="https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp">https://html.spec.whatwg.org/multipage/interaction.html#last-activation-timestamp</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-last-activation-timestamp">1.1. Close watcher infrastructure</a> <a href="#ref-for-last-activation-timestamp①">(2)</a>
    <li><a href="#ref-for-last-activation-timestamp②">1.2. Close watcher API</a> <a href="#ref-for-last-activation-timestamp③">(2)</a>
    <li><a href="#ref-for-last-activation-timestamp④">2.2. The dialog element</a> <a href="#ref-for-last-activation-timestamp⑤">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-event-popstate">
   <a href="https://html.spec.whatwg.org/multipage/indices.html#event-popstate">https://html.spec.whatwg.org/multipage/indices.html#event-popstate</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-event-popstate">3.2. Privacy considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-queue-a-global-task">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task">https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-queue-a-global-task">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-queue-a-task">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-queue-a-task">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-relevant-global">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global">https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-relevant-global">1. Close signals</a>
    <li><a href="#ref-for-concept-relevant-global①">1.2. Close watcher API</a> <a href="#ref-for-concept-relevant-global②">(2)</a> <a href="#ref-for-concept-relevant-global③">(3)</a> <a href="#ref-for-concept-relevant-global④">(4)</a>
    <li><a href="#ref-for-concept-relevant-global⑤">2.2. The dialog element</a> <a href="#ref-for-concept-relevant-global⑥">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-dialog-showmodal">
   <a href="https://html.spec.whatwg.org/multipage/interactive-elements.html#dom-dialog-showmodal">https://html.spec.whatwg.org/multipage/interactive-elements.html#dom-dialog-showmodal</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-dialog-showmodal">2.2. The dialog element</a> <a href="#ref-for-dom-dialog-showmodal①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-transient-activation">
   <a href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation">https://html.spec.whatwg.org/multipage/interaction.html#transient-activation</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-transient-activation">1.1. Close watcher infrastructure</a> <a href="#ref-for-transient-activation①">(2)</a>
    <li><a href="#ref-for-transient-activation②">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-activation-consuming-api">
   <a href="https://html.spec.whatwg.org/multipage/interaction.html#activation-consuming-api">https://html.spec.whatwg.org/multipage/interaction.html#activation-consuming-api</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-activation-consuming-api">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-traverse-the-history-by-a-delta">
   <a href="https://html.spec.whatwg.org/multipage/history.html#traverse-the-history-by-a-delta">https://html.spec.whatwg.org/multipage/history.html#traverse-the-history-by-a-delta</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-traverse-the-history-by-a-delta">1. Close signals</a>
    <li><a href="#ref-for-traverse-the-history-by-a-delta①">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-user-interaction-task-source">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source">https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-user-interaction-task-source">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-iteration-break">
   <a href="https://infra.spec.whatwg.org/#iteration-break">https://infra.spec.whatwg.org/#iteration-break</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-iteration-break">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-list-iterate">
   <a href="https://infra.spec.whatwg.org/#list-iterate">https://infra.spec.whatwg.org/#list-iterate</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-list-iterate">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-implementation-defined">
   <a href="https://infra.spec.whatwg.org/#implementation-defined">https://infra.spec.whatwg.org/#implementation-defined</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-implementation-defined">1. Close signals</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-struct-item">
   <a href="https://infra.spec.whatwg.org/#struct-item">https://infra.spec.whatwg.org/#struct-item</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-struct-item">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-struct-item①">1.2. Close watcher API</a>
    <li><a href="#ref-for-struct-item②">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-stack-pop">
   <a href="https://infra.spec.whatwg.org/#stack-pop">https://infra.spec.whatwg.org/#stack-pop</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-stack-pop">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-stack-push">
   <a href="https://infra.spec.whatwg.org/#stack-push">https://infra.spec.whatwg.org/#stack-push</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-stack-push">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-stack-push①">1.2. Close watcher API</a>
    <li><a href="#ref-for-stack-push②">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-stack">
   <a href="https://infra.spec.whatwg.org/#stack">https://infra.spec.whatwg.org/#stack</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-stack">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-struct">
   <a href="https://infra.spec.whatwg.org/#struct">https://infra.spec.whatwg.org/#struct</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-struct">1.1. Close watcher infrastructure</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-event-type-keydown">
   <a href="https://w3c.github.io/uievents/#event-type-keydown">https://w3c.github.io/uievents/#event-type-keydown</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-event-type-keydown">1. Close signals</a> <a href="#ref-for-event-type-keydown①">(2)</a> <a href="#ref-for-event-type-keydown②">(3)</a> <a href="#ref-for-event-type-keydown③">(4)</a> <a href="#ref-for-event-type-keydown④">(5)</a>
    <li><a href="#ref-for-event-type-keydown⑤">3.2. Privacy considerations</a> <a href="#ref-for-event-type-keydown⑥">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-event-type-keyup">
   <a href="https://w3c.github.io/uievents/#event-type-keyup">https://w3c.github.io/uievents/#event-type-keyup</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-event-type-keyup">1. Close signals</a> <a href="#ref-for-event-type-keyup①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-idl-DOMException">
   <a href="https://webidl.spec.whatwg.org/#idl-DOMException">https://webidl.spec.whatwg.org/#idl-DOMException</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-idl-DOMException">1.2. Close watcher API</a> <a href="#ref-for-idl-DOMException①">(2)</a> <a href="#ref-for-idl-DOMException②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-Exposed">
   <a href="https://webidl.spec.whatwg.org/#Exposed">https://webidl.spec.whatwg.org/#Exposed</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-Exposed">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-invalidstateerror">
   <a href="https://webidl.spec.whatwg.org/#invalidstateerror">https://webidl.spec.whatwg.org/#invalidstateerror</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-invalidstateerror">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-notallowederror">
   <a href="https://webidl.spec.whatwg.org/#notallowederror">https://webidl.spec.whatwg.org/#notallowederror</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-notallowederror">1.2. Close watcher API</a> <a href="#ref-for-notallowederror①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-this">
   <a href="https://webidl.spec.whatwg.org/#this">https://webidl.spec.whatwg.org/#this</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-this">1.2. Close watcher API</a> <a href="#ref-for-this①">(2)</a> <a href="#ref-for-this②">(3)</a> <a href="#ref-for-this③">(4)</a> <a href="#ref-for-this④">(5)</a> <a href="#ref-for-this⑤">(6)</a> <a href="#ref-for-this⑥">(7)</a> <a href="#ref-for-this⑦">(8)</a> <a href="#ref-for-this⑧">(9)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-idl-undefined">
   <a href="https://webidl.spec.whatwg.org/#idl-undefined">https://webidl.spec.whatwg.org/#idl-undefined</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-idl-undefined">1.2. Close watcher API</a> <a href="#ref-for-idl-undefined①">(2)</a>
   </ul>
  </aside>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CONSOLE]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-report-a-warning-to-the-console">report a warning to the console</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-document">Document</span>
     <li><span class="dfn-paneled" id="term-for-eventtarget">EventTarget</span>
     <li><span class="dfn-paneled" id="term-for-dom-event-cancelable">cancelable</span>
     <li><span class="dfn-paneled" id="term-for-canceled-flag">canceled flag</span>
     <li><span class="dfn-paneled" id="term-for-concept-event-fire">fire an event</span>
     <li><span class="dfn-paneled" id="term-for-concept-node-document">node document</span>
     <li><span class="dfn-paneled" id="term-for-dom-event-preventdefault">preventDefault()</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FULLSCREEN]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-fullscreen-element">fullscreen element</span>
     <li><span class="dfn-paneled" id="term-for-eventdef-document-fullscreenchange">fullscreenchange</span>
     <li><span class="dfn-paneled" id="term-for-fully-exit-fullscreen">fully exit fullscreen</span>
     <li><span class="dfn-paneled" id="term-for-top-layer">top layer</span>
    </ul>
   <li>
    <a data-link-type="biblio">[hr-time-2]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-dom-domhighrestimestamp">DOMHighResTimeStamp</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-eventhandler">EventHandler</span>
     <li><span class="dfn-paneled" id="term-for-window">Window</span>
     <li><span class="dfn-paneled" id="term-for-concept-document-window">associated document</span>
     <li><span class="dfn-paneled" id="term-for-blocked-by-a-modal-dialog">blocked by a modal dialog</span>
     <li><span class="dfn-paneled" id="term-for-event-cancel">cancel</span>
     <li><span class="dfn-paneled" id="term-for-close-the-dialog">closed</span>
     <li><span class="dfn-paneled" id="term-for-consume-user-activation">consume user activation</span>
     <li><span class="dfn-paneled" id="term-for-the-dialog-element">dialog</span>
     <li><span class="dfn-paneled" id="term-for-event-handler-event-type">event handler event type</span>
     <li><span class="dfn-paneled" id="term-for-event-handler-idl-attributes">event handler idl attribute</span>
     <li><span class="dfn-paneled" id="term-for-fully-active">fully active</span>
     <li><span class="dfn-paneled" id="term-for-last-activation-timestamp">last activation timestamp</span>
     <li><span class="dfn-paneled" id="term-for-event-popstate">popstate</span>
     <li><span class="dfn-paneled" id="term-for-queue-a-global-task">queue a global task</span>
     <li><span class="dfn-paneled" id="term-for-queue-a-task">queue a task</span>
     <li><span class="dfn-paneled" id="term-for-concept-relevant-global">relevant global object</span>
     <li><span class="dfn-paneled" id="term-for-dom-dialog-showmodal">showModal()</span>
     <li><span class="dfn-paneled" id="term-for-transient-activation">transient activation</span>
     <li><span class="dfn-paneled" id="term-for-activation-consuming-api">transient activation-consuming api</span>
     <li><span class="dfn-paneled" id="term-for-traverse-the-history-by-a-delta">traverse the history by a delta</span>
     <li><span class="dfn-paneled" id="term-for-user-interaction-task-source">user interaction task source</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-iteration-break">break</span>
     <li><span class="dfn-paneled" id="term-for-list-iterate">for each</span>
     <li><span class="dfn-paneled" id="term-for-implementation-defined">implementation-defined</span>
     <li><span class="dfn-paneled" id="term-for-struct-item">item</span>
     <li><span class="dfn-paneled" id="term-for-stack-pop">pop</span>
     <li><span class="dfn-paneled" id="term-for-stack-push">push</span>
     <li><span class="dfn-paneled" id="term-for-stack">stack</span>
     <li><span class="dfn-paneled" id="term-for-struct">struct</span>
    </ul>
   <li>
    <a data-link-type="biblio">[UI-EVENTS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-event-type-keydown">keydown</span>
     <li><span class="dfn-paneled" id="term-for-event-type-keyup">keyup</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-idl-DOMException">DOMException</span>
     <li><span class="dfn-paneled" id="term-for-Exposed">Exposed</span>
     <li><span class="dfn-paneled" id="term-for-invalidstateerror">InvalidStateError</span>
     <li><span class="dfn-paneled" id="term-for-notallowederror">NotAllowedError</span>
     <li><span class="dfn-paneled" id="term-for-this">this</span>
     <li><span class="dfn-paneled" id="term-for-idl-undefined">undefined</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fullscreen">[FULLSCREEN]
   <dd>Philip Jägenstedt. <a href="https://fullscreen.spec.whatwg.org/"><cite>Fullscreen API Standard</cite></a>. Living Standard. URL: <a href="https://fullscreen.spec.whatwg.org/">https://fullscreen.spec.whatwg.org/</a>
   <dt id="biblio-hr-time-2">[HR-TIME-2]
   <dd>Ilya Grigorik. <a href="https://w3c.github.io/hr-time/"><cite>High Resolution Time Level 2</cite></a>. URL: <a href="https://w3c.github.io/hr-time/">https://w3c.github.io/hr-time/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-ui-events">[UI-EVENTS]
   <dd>Gary Kacmarcik; Travis Leithead. <a href="https://w3c.github.io/uievents/"><cite>UI Events</cite></a>. URL: <a href="https://w3c.github.io/uievents/">https://w3c.github.io/uievents/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-console">[CONSOLE]
   <dd>Dominic Farolino; Robert Kowalski; Terin Stock. <a href="https://console.spec.whatwg.org/"><cite>Console Standard</cite></a>. Living Standard. URL: <a href="https://console.spec.whatwg.org/">https://console.spec.whatwg.org/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <a href="#closewatcher"><code><c- g>CloseWatcher</c-></code></a> : <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#eventtarget"><c- n>EventTarget</c-></a> {
  <a class="idl-code" data-link-type="constructor" href="#dom-closewatcher-closewatcher"><c- g>constructor</c-></a>();

  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined"><c- b>undefined</c-></a> <a class="idl-code" data-link-type="method" href="#dom-closewatcher-destroy"><c- g>destroy</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined"><c- b>undefined</c-></a> <a class="idl-code" data-link-type="method" href="#dom-closewatcher-close"><c- g>close</c-></a>();

  <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-closewatcher-oncancel"><c- g>oncancel</c-></a>;
  <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-closewatcher-onclose"><c- g>onclose</c-></a>;
};

</pre>
  <aside class="dfn-panel" data-for="close-signal">
   <b><a href="#close-signal">#close-signal</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-signal">1. Close signals</a> <a href="#ref-for-close-signal①">(2)</a>
    <li><a href="#ref-for-close-signal②">1.2. Close watcher API</a> <a href="#ref-for-close-signal③">(2)</a> <a href="#ref-for-close-signal④">(3)</a>
    <li><a href="#ref-for-close-signal⑤">2.1. Fullscreen</a>
    <li><a href="#ref-for-close-signal⑥">2.2. The dialog element</a>
    <li><a href="#ref-for-close-signal⑦">3.1. Security considerations</a> <a href="#ref-for-close-signal⑧">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="close-signal-steps">
   <b><a href="#close-signal-steps">#close-signal-steps</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-signal-steps">2.1. Fullscreen</a>
    <li><a href="#ref-for-close-signal-steps①">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="close-watcher-stack">
   <b><a href="#close-watcher-stack">#close-watcher-stack</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-watcher-stack">1.1. Close watcher infrastructure</a> <a href="#ref-for-close-watcher-stack①">(2)</a> <a href="#ref-for-close-watcher-stack②">(3)</a> <a href="#ref-for-close-watcher-stack③">(4)</a>
    <li><a href="#ref-for-close-watcher-stack④">1.2. Close watcher API</a>
    <li><a href="#ref-for-close-watcher-stack⑤">2.2. The dialog element</a>
    <li><a href="#ref-for-close-watcher-stack⑥">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="timestamp-of-last-activation-used-for-close-watchers">
   <b><a href="#timestamp-of-last-activation-used-for-close-watchers">#timestamp-of-last-activation-used-for-close-watchers</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-timestamp-of-last-activation-used-for-close-watchers">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-timestamp-of-last-activation-used-for-close-watchers①">1.2. Close watcher API</a> <a href="#ref-for-timestamp-of-last-activation-used-for-close-watchers②">(2)</a>
    <li><a href="#ref-for-timestamp-of-last-activation-used-for-close-watchers③">2.2. The dialog element</a> <a href="#ref-for-timestamp-of-last-activation-used-for-close-watchers④">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="close-watcher">
   <b><a href="#close-watcher">#close-watcher</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-watcher">1. Close signals</a>
    <li><a href="#ref-for-close-watcher①">1.1. Close watcher infrastructure</a> <a href="#ref-for-close-watcher②">(2)</a>
    <li><a href="#ref-for-close-watcher③">1.2. Close watcher API</a>
    <li><a href="#ref-for-close-watcher④">2.1. Fullscreen</a>
    <li><a href="#ref-for-close-watcher⑤">2.2. The dialog element</a>
    <li><a href="#ref-for-close-watcher⑥">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="close-watcher-close-action">
   <b><a href="#close-watcher-close-action">#close-watcher-close-action</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-watcher-close-action">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-close-watcher-close-action①">1.2. Close watcher API</a>
    <li><a href="#ref-for-close-watcher-close-action②">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="close-watcher-is-still-valid">
   <b><a href="#close-watcher-is-still-valid">#close-watcher-is-still-valid</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-watcher-is-still-valid">1. Close signals</a>
    <li><a href="#ref-for-close-watcher-is-still-valid①">1.1. Close watcher infrastructure</a> <a href="#ref-for-close-watcher-is-still-valid②">(2)</a> <a href="#ref-for-close-watcher-is-still-valid③">(3)</a>
    <li><a href="#ref-for-close-watcher-is-still-valid④">1.2. Close watcher API</a>
    <li><a href="#ref-for-close-watcher-is-still-valid⑤">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="close-watcher-blocks-further-developer-controlled-close-watchers">
   <b><a href="#close-watcher-blocks-further-developer-controlled-close-watchers">#close-watcher-blocks-further-developer-controlled-close-watchers</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-close-watcher-blocks-further-developer-controlled-close-watchers">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-close-watcher-blocks-further-developer-controlled-close-watchers①">1.2. Close watcher API</a>
    <li><a href="#ref-for-close-watcher-blocks-further-developer-controlled-close-watchers②">2.2. The dialog element</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="signal-close">
   <b><a href="#signal-close">#signal-close</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-signal-close">1. Close signals</a> <a href="#ref-for-signal-close①">(2)</a> <a href="#ref-for-signal-close②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="check-if-we-can-create-a-developer-controlled-close-watcher">
   <b><a href="#check-if-we-can-create-a-developer-controlled-close-watcher">#check-if-we-can-create-a-developer-controlled-close-watcher</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-check-if-we-can-create-a-developer-controlled-close-watcher">1.2. Close watcher API</a>
    <li><a href="#ref-for-check-if-we-can-create-a-developer-controlled-close-watcher①">2.2. The dialog element</a>
    <li><a href="#ref-for-check-if-we-can-create-a-developer-controlled-close-watcher②">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="closewatcher">
   <b><a href="#closewatcher">#closewatcher</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-closewatcher">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-closewatcher①">1.2. Close watcher API</a> <a href="#ref-for-closewatcher②">(2)</a> <a href="#ref-for-closewatcher③">(3)</a> <a href="#ref-for-closewatcher④">(4)</a> <a href="#ref-for-closewatcher⑤">(5)</a> <a href="#ref-for-closewatcher⑥">(6)</a> <a href="#ref-for-closewatcher⑦">(7)</a> <a href="#ref-for-closewatcher⑧">(8)</a>
    <li><a href="#ref-for-closewatcher⑨">3.1. Security considerations</a> <a href="#ref-for-closewatcher①⓪">(2)</a> <a href="#ref-for-closewatcher①①">(3)</a>
    <li><a href="#ref-for-closewatcher①②">3.2. Privacy considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="closewatcher-is-active">
   <b><a href="#closewatcher-is-active">#closewatcher-is-active</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-closewatcher-is-active">1.2. Close watcher API</a> <a href="#ref-for-closewatcher-is-active①">(2)</a> <a href="#ref-for-closewatcher-is-active②">(3)</a> <a href="#ref-for-closewatcher-is-active③">(4)</a> <a href="#ref-for-closewatcher-is-active④">(5)</a> <a href="#ref-for-closewatcher-is-active⑤">(6)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="closewatcher-firing-cancel-event">
   <b><a href="#closewatcher-firing-cancel-event">#closewatcher-firing-cancel-event</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-closewatcher-firing-cancel-event">1.2. Close watcher API</a> <a href="#ref-for-closewatcher-firing-cancel-event①">(2)</a> <a href="#ref-for-closewatcher-firing-cancel-event②">(3)</a> <a href="#ref-for-closewatcher-firing-cancel-event③">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="dom-closewatcher-closewatcher">
   <b><a href="#dom-closewatcher-closewatcher">#dom-closewatcher-closewatcher</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-closewatcher-closewatcher">1.2. Close watcher API</a> <a href="#ref-for-dom-closewatcher-closewatcher①">(2)</a>
    <li><a href="#ref-for-dom-closewatcher-closewatcher②">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="dom-closewatcher-destroy">
   <b><a href="#dom-closewatcher-destroy">#dom-closewatcher-destroy</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-closewatcher-destroy">1.2. Close watcher API</a> <a href="#ref-for-dom-closewatcher-destroy①">(2)</a> <a href="#ref-for-dom-closewatcher-destroy②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="dom-closewatcher-close">
   <b><a href="#dom-closewatcher-close">#dom-closewatcher-close</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-closewatcher-close">1.2. Close watcher API</a> <a href="#ref-for-dom-closewatcher-close①">(2)</a> <a href="#ref-for-dom-closewatcher-close②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="dom-closewatcher-oncancel">
   <b><a href="#dom-closewatcher-oncancel">#dom-closewatcher-oncancel</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-closewatcher-oncancel">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="dom-closewatcher-onclose">
   <b><a href="#dom-closewatcher-onclose">#dom-closewatcher-onclose</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-closewatcher-onclose">1.2. Close watcher API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="eventdef-closewatcher-cancel">
   <b><a href="#eventdef-closewatcher-cancel">#eventdef-closewatcher-cancel</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-eventdef-closewatcher-cancel">1.1. Close watcher infrastructure</a>
    <li><a href="#ref-for-eventdef-closewatcher-cancel①">1.2. Close watcher API</a>
    <li><a href="#ref-for-eventdef-closewatcher-cancel②">3.1. Security considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="eventdef-closewatcher-close">
   <b><a href="#eventdef-closewatcher-close">#eventdef-closewatcher-close</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-eventdef-closewatcher-close">1.2. Close watcher API</a> <a href="#ref-for-eventdef-closewatcher-close①">(2)</a> <a href="#ref-for-eventdef-closewatcher-close②">(3)</a> <a href="#ref-for-eventdef-closewatcher-close③">(4)</a>
    <li><a href="#ref-for-eventdef-closewatcher-close④">3.2. Privacy considerations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="closewatcher-signal-close">
   <b><a href="#closewatcher-signal-close">#closewatcher-signal-close</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-closewatcher-signal-close">1.2. Close watcher API</a> <a href="#ref-for-closewatcher-signal-close①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="cancel-the-dialog">
   <b><a href="#cancel-the-dialog">#cancel-the-dialog</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-cancel-the-dialog">2.2. The dialog element</a>
   </ul>
  </aside>
<script>/* script-dfn-panel */

document.body.addEventListener("click", function(e) {
    var queryAll = function(sel) { return [].slice.call(document.querySelectorAll(sel)); }
    // Find the dfn element or panel, if any, that was clicked on.
    var el = e.target;
    var target;
    var hitALink = false;
    while(el.parentElement) {
        if(el.tagName == "A") {
            // Clicking on a link in a <dfn> shouldn't summon the panel
            hitALink = true;
        }
        if(el.classList.contains("dfn-paneled")) {
            target = "dfn";
            break;
        }
        if(el.classList.contains("dfn-panel")) {
            target = "dfn-panel";
            break;
        }
        el = el.parentElement;
    }
    if(target != "dfn-panel") {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(function(el){
            el.classList.remove("on");
            el.classList.remove("activated");
        });
    }
    if(target == "dfn" && !hitALink) {
        // open the panel
        var dfnPanel = document.querySelector(".dfn-panel[data-for='" + el.id + "']");
        if(dfnPanel) {
            dfnPanel.classList.add("on");
            var rect = el.getBoundingClientRect();
            dfnPanel.style.left = window.scrollX + rect.right + 5 + "px";
            dfnPanel.style.top = window.scrollY + rect.top + "px";
            var panelRect = dfnPanel.getBoundingClientRect();
            var panelWidth = panelRect.right - panelRect.left;
            if(panelRect.right > document.body.scrollWidth && (rect.left - (panelWidth + 5)) > 0) {
                // Reposition, because the panel is overflowing
                dfnPanel.style.left = window.scrollX + rect.left - (panelWidth + 5) + "px";
            }
        } else {
            console.log("Couldn't find .dfn-panel[data-for='" + el.id + "']");
        }
    } else if(target == "dfn-panel") {
        // Switch it to "activated" state, which pins it.
        el.classList.add("activated");
        el.style.left = null;
        el.style.top = null;
    }

});
</script>
<script>/* script-var-click-highlighting */

    document.addEventListener("click", e=>{
        if(e.target.nodeName == "VAR") {
            highlightSameAlgoVars(e.target);
        }
    });
    {
        const indexCounts = new Map();
        const indexNames = new Map();
        function highlightSameAlgoVars(v) {
            // Find the algorithm container.
            let algoContainer = null;
            let searchEl = v;
            while(algoContainer == null && searchEl != document.body) {
                searchEl = searchEl.parentNode;
                if(searchEl.hasAttribute("data-algorithm")) {
                    algoContainer = searchEl;
                }
            }

            // Not highlighting document-global vars,
            // too likely to be unrelated.
            if(algoContainer == null) return;

            const algoName = algoContainer.getAttribute("data-algorithm");
            const varName = getVarName(v);
            const addClass = !v.classList.contains("selected");
            let highlightClass = null;
            if(addClass) {
                const index = chooseHighlightIndex(algoName, varName);
                indexCounts.get(algoName)[index] += 1;
                indexNames.set(algoName+"///"+varName, index);
                highlightClass = nameFromIndex(index);
            } else {
                const index = previousHighlightIndex(algoName, varName);
                indexCounts.get(algoName)[index] -= 1;
                highlightClass = nameFromIndex(index);
            }

            // Find all same-name vars, and toggle their class appropriately.
            for(const el of algoContainer.querySelectorAll("var")) {
                if(getVarName(el) == varName) {
                    el.classList.toggle("selected", addClass);
                    el.classList.toggle(highlightClass, addClass);
                }
            }
        }
        function getVarName(el) {
            return el.textContent.replace(/(\s|\xa0)+/, " ").trim();
        }
        function chooseHighlightIndex(algoName, varName) {
            let indexes = null;
            if(indexCounts.has(algoName)) {
                indexes = indexCounts.get(algoName);
            } else {
                // 7 classes right now
                indexes = [0,0,0,0,0,0,0];
                indexCounts.set(algoName, indexes);
            }

            // If the element was recently unclicked,
            // *and* that color is still unclaimed,
            // give it back the same color.
            const lastIndex = previousHighlightIndex(algoName, varName);
            if(indexes[lastIndex] === 0) return lastIndex;

            // Find the earliest index with the lowest count.
            const minCount = Math.min.apply(null, indexes);
            let index = null;
            for(var i = 0; i < indexes.length; i++) {
                if(indexes[i] == minCount) {
                    return i;
                }
            }
        }
        function previousHighlightIndex(algoName, varName) {
            return indexNames.get(algoName+"///"+varName);
        }
        function nameFromIndex(index) {
            return "selected" + index;
        }
    }
    </script>